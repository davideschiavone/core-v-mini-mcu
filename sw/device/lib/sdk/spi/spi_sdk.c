/*
                              *******************
******************************* C SOURCE FILE *****************************
**                            *******************
**
** project  : X-HEEP
** filename : spi_sdk.c
** version  : 1
** date     : 18/04/24
**
***************************************************************************
**
** Copyright (c) EPFL contributors.
** All rights reserved.
**
***************************************************************************
*/

/***************************************************************************/
/***************************************************************************/
/**
* @file   spi_sdk.c
* @date   18/04/24
* @brief  The Serial Peripheral Interface (SPI) SDK to set up and use the
* SPI peripheral
*/

/****************************************************************************/
/**                                                                        **/
/**                            MODULES USED                                **/
/**                                                                        **/
/****************************************************************************/

#include "spi_sdk.h"
#include "spi_host.h"

/****************************************************************************/
/**                                                                        **/
/**                       DEFINITIONS AND MACROS                           **/
/**                                                                        **/
/****************************************************************************/

/****************************************************************************/
/**                                                                        **/
/**                       TYPEDEFS AND STRUCTURES                          **/
/**                                                                        **/
/****************************************************************************/

typedef struct {
    spi_host_t* instance;
    bool busy;
    uint32_t* txbuffer;
    uint32_t* rxbuffer;
} spi_t;

/****************************************************************************/
/**                                                                        **/
/*                      PROTOTYPES OF LOCAL FUNCTIONS                       */
/**                                                                        **/
/****************************************************************************/

/****************************************************************************/
/**                                                                        **/
/**                          EXPORTED VARIABLES                            **/
/**                                                                        **/
/****************************************************************************/

/****************************************************************************/
/**                                                                        **/
/*                            GLOBAL VARIABLES                              */
/**                                                                        **/
/****************************************************************************/

spi_t* _spi_array[] = {NULL, NULL, NULL};

/****************************************************************************/
/**                                                                        **/
/**                          EXPORTED FUNCTIONS                            **/
/**                                                                        **/
/****************************************************************************/

spi_codes_e spi_init(spi_idx_e idx) {
    if (SPI_IDX_INVALID(idx))    return SPI_CODE_IDX_INVAL;
    if (_spi_array[idx] != NULL) return SPI_CODE_INIT;

    spi_t* spi    = malloc(sizeof(spi_t));
    spi->instance = spi_init_flash();
    spi->busy     = false;
    spi->txbuffer = NULL;
    spi->rxbuffer = NULL;

    _spi_array[idx] = spi;
    return SPI_CODE_OK;
}

spi_codes_e spi_deinit(spi_idx_e idx) {
    if (SPI_IDX_INVALID(idx))    return SPI_CODE_IDX_INVAL;
    if (_spi_array[idx] == NULL) return SPI_CODE_NOT_INIT;

    free(_spi_array[idx]);

    _spi_array[idx] = NULL;
    return SPI_CODE_OK;
}

/****************************************************************************/
/**                                                                        **/
/*                            LOCAL FUNCTIONS                               */
/**                                                                        **/
/****************************************************************************/

/****************************************************************************/
/**                                                                        **/
/**                                EOF                                     **/
/**                                                                        **/
/****************************************************************************/
