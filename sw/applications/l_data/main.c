#include "datahelper.h"
#include "utils.h"
#include <assert.h>
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include <stdbool.h>

#define COMP_PREC 0.00001f

static float a1[] = { 123.04050162592358, -128.71307015233148, 135.3744134753319, 103.11344412842786, -46.7358607709171, 116.00302080210878, 82.62329400495238, -76.20943485909036, -90.71184986089287, 41.93325453498443,};
float mean = 25.971771292849713;
float std = 96.0113380509814;

int len = 256;
static float a2[] = { 36.40057228916555, -17.4873357823476, -127.25548939081504, -66.02360370727564, -115.35054254378875, 65.73317391590518, 39.6949855266501, -145.09952906073406, 138.76658756925195, 136.14229311557222, 149.64786973323032, -64.23458088252782, 17.671085816474374, -8.62910339947615, -14.73183117957484, 53.96449574858704, 92.446904437044, 68.97978386740812, 16.74350286170096, -94.40070777490078, 116.65733781875741, 124.1243397609166, 125.68590292547839, 134.85723645020056, -135.0245927377151, 112.09498882902591, -58.53839219009234, -111.71841610369637, 113.19041310960239, 109.79335415905297, 20.2605781235022, -100.54927797366389, 25.02276994149426, 71.27468330174392, 32.80112840449547, -0.20022823602866424, -102.62475576256529, -23.487294095268467, 73.0374692535255, 50.458234758543, 85.48229956353077, -46.055447986430735, -6.566758014056262, 2.5167432144677093, 78.64098835139595, -25.677090531806698, 15.109131868753877, -4.395924509437549, -113.44452582042501, -21.243077142712707, -14.74825334934053, -35.725321576837715, 30.364162895528978, -80.95320140964742, 114.24107647970163, 18.66090475050899, -110.99028355341278, -67.24633889812246, -91.2489710325416, -111.82450407627948, 31.589279036576414, -55.247504773469174, -58.476559650457745, -107.309058855176, 35.17204234335952, -149.6360920619463, 147.10690080516474, -122.01002100818047, 140.56206843670248, -52.14519294211374, 41.499937542445, -101.97676942639455, 134.7644732505678, -25.73898973783534, 9.235056563443976, -91.6564063811775, -77.67441611363908, 68.59854728249084, -59.08651010389188, -52.0164041508058, -64.95272996504757, -129.44357734905816, 8.264954133645062, -106.71647342293014, 119.39100698873267, 78.36363524286313, -39.49332364947908, -121.79035268053981, 32.574542780391226, 128.0971677828387, -21.626110308379282, -102.69055420528288, 67.4656767004661, -123.21323138826772, -120.49920470166975, -76.53548442575733, -72.77121451373446, 28.58146810851855, -28.537533893781514, 75.96696982700661, 146.0634156929783, -33.399647769565334, 75.51169508833624, 83.36387184275691, -68.10958431147702, 75.24042423399985, -71.97962718797561, -32.17028705192459, -95.42791421796835, -11.996529807894888, 42.27941921543939, 41.7125096915548, -112.04688924854452, -81.55447055320181, -148.42021976204154, -5.111254520550375, -126.68728743945219, -130.126537788591, -99.72941117018394, -98.2031169251074, 71.294757755586, -1.9341868013485168, -98.4659236352466, 149.00213908914589, 117.24063932453572, -39.73132407748264, 15.091902394279572, 94.91645496147964, -135.58034176776664, -59.25830714184035, -33.641433737941625, -133.6021860559324, -139.54537424274582, 113.69495768322861, -45.257593138771384, 21.983571358037523, -149.12416998415887, -102.9644852364416, -118.57312058834336, -91.24912914087662, 65.41443112820448, 30.4657292518161, 33.4278969140432, -59.33266130882568, 124.20848116332098, -19.74551275436113, -58.72246576618829, -24.915437801168608, 89.20433967079151, 55.19538921266104, -52.15596277773072, -12.547448271854591, -83.69341343012596, 104.13118666721093, 90.69054617716188, 136.31941626173398, 42.93480361810333, 127.05473574597863, -144.1834644180072, -69.45246058460488, -89.76739198374209, -88.42516037596269, -28.344011427569654, -76.36762914821325, 102.82285072212568, -95.77937873505073, -73.88271820881415, -53.296799332230506, -81.95310166563637, 20.96966578559531, 97.19016968338028, 86.41715047563864, 27.116739877975732, 82.08118811104484, -136.6808944624087, -134.2188597368059, -0.7095783113232983, -47.736595751619745, -41.596456306179235, -38.51073306766949, 12.94547416158801, -23.602828947640305, -59.92223516738801, -74.54134353941554, -57.98743506675068, 3.729766894213526, -27.29977236913703, -10.662489375175426, -123.45778266402866, -40.3977773609477, -12.777049318291745, 88.97632585057187, -123.00624392769492, 44.49190355377513, 126.17689393233866, 67.81614514412152, -105.79449434434196, 4.437560052603715, 18.422700909937504, 98.85309726181973, 42.4882072462361, -53.424870567329194, 8.172918229775462, 144.58333289139807, -21.166346997422778, -50.16647607514486, -4.56970898860601, 30.738608514800035, 121.10008566874626, 72.27634952511264, -19.372257247347335, 68.43210539602745, 43.3525071907024, -140.57910192783348, 95.18689839911093, -121.0466797029768, 65.23580169950878, 72.16859627562576, -10.328434919163385, -149.23978600604835, 71.77105027840398, -74.79512320335074, -44.32231374630257, 96.10046289502418, 59.48511414005412, 34.802002192617834, -102.77662804130051, -102.77396235621572, -61.65058214367913, -17.406994931962743, 93.53697575530498, 117.88803127314878, 141.63767049706166, 131.6182043100075, -96.95088443464903, 126.75096198251231, 58.85097613184519, -147.81721491115476, -103.51325596033976, -26.141082353455715, 86.85750303364668, -8.798406372863809, -107.34828370364257, 6.03896424247128, 142.1130272880979, -15.296031442415313, 61.922444380523444, 147.24446407910665, -141.14842801389815, -50.34133098334529, -107.74027398819815, 121.2313290997945, -68.58210567618356, 23.287102140421638, -60.86204674564932, -136.0875262693496,};
float mean2 = -7.1283687740938095;
float std2 = 85.26595529678028;

void test_normalizemvf() {
    float* a = (float*)malloc(10 * sizeof(float));
    memcpy(a, a1, 10 * sizeof(float));
    DataMSf mv = Data_normalizeMVf(a, 10);
    assert_closef(mv.mean, mean, COMP_PREC);
    assert_closef(mv.std, std, COMP_PREC);
    Data_denormalizef(a, 10, mv);
    for (int i = 0; i < 10; ++i) {
        assert_closef(a[i], a1[i], COMP_PREC);
    }
}

void test_normalizemvf2() {
    float* a = (float*)malloc(len * sizeof(float));
    memcpy(a, a2, len * sizeof(float));
    DataMSf mv = Data_normalizeMVf(a2, len);
    assert_closef(mv.mean, mean2, COMP_PREC);
    assert_closef(mv.std, std2, COMP_PREC);
    Data_denormalizef(a2, len, mv);
    for (int i = 0; i < len; ++i) {
        assert_closef(a2[i], a[i], COMP_PREC);
    }
}

//TODO:
// void test_normalizemv() {
//     fxp32* a = (fxp32*)malloc(10 * sizeof(fxp32));
//     for (int i = 0; i < 10; ++i) {
//         a[i] = fxp32_fromFloat(a1[i]);
//     }
//     DataMS mv = Data_normalizeMV(a, 10);
//     my_assert(fxp32_close(mv.mean, fxp32_fromFloat(mean), fxp32_fromFloat(COMP_PREC)));
//     my_assert(fxp32_close(mv.std, fxp32_fromFloat(std), fxp32_fromFloat(COMP_PREC)));
//     for(int i = 0; i < 10; ++i) {
//         printf("a[%d]: %f\n", i, fxp32_toFloat(a[i]));
//     }
//     Data_denormalize(a, 10, mv);
//     for (int i = 0; i < 10; ++i) {
//         my_assert(fxp32_close(a[i], fxp32_fromFloat(a1[i]), fxp32_fromFloat(COMP_PREC)));
//     }
// }

int main() {
    PRINTF("\033[1;93m====== Test Datahelper =====\n");
    PRINTF("\033[0m====== Test Norm =========\n");
    test_normalizemvf();
    PRINTF("\033[1;32m====== Test 1 passed =====\n");
    test_normalizemvf2();
    PRINTF("\033[1;32m====== Test 2 passed =====\n");
    PRINTF("\033[0m====== Test Norm end =====\n\n");
    return 0;
}