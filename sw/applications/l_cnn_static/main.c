#include <stdbool.h>
#include <stdio.h>
#include <stdlib.h>

#include "cnn.h"
#include "fxp32.h"
#include "utils.h"

// #define DYN_ALLOCATION
#define COMP_PREC     0.0001f
#define COMP_PREC_I32 512

void compareVectorsFloat(float* a, float* b, int size, float prec) {
    for (int i = 0; i < size; ++i) {
        assert_closef(a[i], b[i], prec);
    }
}

void compareVectorsFxp(fxp32* a, fxp32* b, int size, float prec) {
    for (int i = 0; i < size; ++i) {
        assert_closei32(a[i], b[i], prec);
    }
}

// clang-format off
#ifndef DYN_ALLOCATION

// Create all arays statically
float inp[] = { 0.10687026183436554, 0.6433775638335413, 1.5719371774211934, 1.8606301880573626, 1.079730707565259, 1.0363964731573039, 0.8401961894177536, 0.8062113303254894, 1.0693255244711337, 1.8973979155425758, -0.5051419304161229, -1.6677822278462204, -1.0414382415511003, -1.1140689598280193, -0.5456008127835759, 1.241256928449407, -1.7596153205346008, -0.20102576841377573, 1.2526821099333798, -0.9430465018374048, -1.7463960721065255, -1.0315693109762605, -1.6597181529991376, 1.231109741389408, -1.3189996974476714, -1.2186214977502452, 1.2585680462314413, 1.2411421167299825, 0.35749551293497017, 1.658937360469848, -1.7607134529814616, 1.859986561081329, 0.28390086742322307, -0.7899275499984229, 1.3028233059934027, 0.637669121413285, 1.9460057656135836, -1.5700418656996042, 0.3236741105335814, -0.10868737977085274, 0.6090831439508024, -1.0325637836102834, -1.8754797463263757, 0.17692941098474302, -0.54115928483046,};
float ke1[] = { 1.2019056830022787, -1.9184344862073974, 0.2904745952311969, -0.3544655368824938, 1.9405471907832181, 1.2056061216442804, -1.7841515914194126, -1.2380889061779894, -0.19032461673209822, 0.8117683084719127, -0.6718074018572904, -0.5600672193147695, 1.685882263836708, 1.8145220229093884, -0.36925708529142565,};
float ke2[] = { 1.594284619538893, -0.6789869921619749, -1.6690457236800493,};
float res[] = { -5.646923391743088, -12.486867124009787, 1.116749990770437, 3.790885823459984, -7.655608446879853, -5.758159525901699, -16.320022556866068, 10.253133245571195, -8.825685721563698, -3.9221345076618483, -11.844371518436887, 16.970633341131517, 5.631829596306385, 4.730155342366402, 6.236770944902686,};
int32_t inp_fxp[] = { 896492, 5397042, 13186365, 15608097, 9057438, 8693924, 7048076, 6762991, 8970153, 15916527, -4237437, -13990371, -8736217, -9345488, -4576831, 10412418, -14760723, -1686326, 10508259, -7910847, -14649832, -8653431, -13922725, 10327297, -11064571, -10222538, 10557634, 10411455, 2998889, 13916175, -14769935, 15602698, 2381533, -6626392, 10928874, 5349156, 16324280, -13170466, 2715175, -911735, 5109359, -8661773, -15732664, 1484191, -4539573,};
int32_t ke1_fxp[] = { 10082316, -16092995, 2436677, -2973472, 16278490, 10113357, -14966548, -10385843, -1596558, 6809606, -5635529, -4698184, 14142205, 15221314, -3097553,};
int32_t ke2_fxp[] = { 13373829, -5695755, -14000970,};
int32_t res_fxp[] = { -47369828, -104747432, 9367978, 31800256, -64219900, -48302944, -136902272, 86009512, -74035216, -32901248, -99357792, 142359984, 47243212, 39679420, 52317828,};

float result[15];
int32_t result_fxp[15];

float layer1Output[3*15];
int32_t layer1OutputFxp[3*15];

#endif
// clang-format on

int main() {
    printf("Running cnn test\n");

    // Create the CNN
    printf("Creating CNN\n");
    Conv2DLayer layer1;
    layer1.dim = (Dim2D){3u, 5u};
    layer1.padding = SAME;
    layer1.weightsFloat = ke1;
    layer1.weightsFxp = ke1_fxp;

    Conv2DLayer layer2;
    layer2.dim = (Dim2D){3u, 1u};
    layer2.padding = VALID;
    layer2.weightsFloat = ke2;
    layer2.weightsFxp = ke2_fxp;

    Cnn cnn;
    cnn.layer1 = &layer1;
    cnn.layer2 = &layer2;
    cnn.inputDim = (Dim2D){3u, 15u};
    cnn.outputDim = (Dim2D){1u, 15u};
    cnn.layer1Output = layer1Output;
    cnn.layer1OutputFxp = layer1OutputFxp;

    // Forward pass
    printf("Forward pass\n");
    Cnn_forwardFloat(&cnn, inp, result);
    Cnn_forwardFxp(&cnn, inp_fxp, result_fxp);

    printf("Comparing results\n");
    compareVectorsFloat(result, res, 15, COMP_PREC * 10);
    compareVectorsFxp(result_fxp, res_fxp, 15, COMP_PREC_I32 * 10);
    printf("Test passed\n");

    return 0;
}